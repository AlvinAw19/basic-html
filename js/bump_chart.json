{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Malaysia State Poverty Rankings Over Time (2016–2022)",
    "subtitle": "Rank 1 = Lowest Poverty (Best) • Click legend to compare states",
    "fontSize": 18,
    "subtitleFontSize": 12,
    "anchor": "start"
  },
  "width": 550,
  "height": 500,
  "data": {"url": "data/poverty_rankings_enhanced.csv"},
  "params": [
    {
      "name": "state_select",
      "select": {"type": "point", "fields": ["state"]},
      "bind": "legend"
    }
  ],
  "layer": [
    {
      "mark": {"type": "rect", "opacity": 0.15, "color": "#ffc107"},
      "data": {"values": [{"year_start": 2019.5, "year_end": 2020.5}]},
      "encoding": {
        "x": {"field": "year_start", "type": "quantitative", "scale": {"domain": [2016, 2022]}},
        "x2": {"field": "year_end"},
        "y": {"value": 0},
        "y2": {"value": 500}
      }
    },
    {
      "mark": {
        "type": "line",
        "strokeWidth": 3,
        "point": {"size": 100, "filled": true}
      },
      "encoding": {
        "x": {
          "field": "year",
          "type": "quantitative",
          "title": "Year",
          "scale": {"domain": [2016, 2022]},
          "axis": {
            "labelAngle": 0,
            "values": [2016, 2018, 2020, 2022],
            "tickCount": 4,
            "format": "d"
          }
        },
        "y": {
          "field": "poverty_rank",
          "type": "quantitative",
          "title": "Poverty Rank (Lower is Better)",
          "scale": {"domain": [0.5, 17.5], "reverse": true},
          "axis": {"tickMinStep": 1}
        },
        "color": {
          "field": "state",
          "type": "nominal",
          "scale": {
            "domain": ["Selangor", "W.P. Putrajaya", "Malaysia (Average)", "Sabah", "Kelantan"],
            "range": ["#1f77b4", "#ff7f0e", "#2ca02c", "#9467bd", "#8c564b"]
          },
          "legend": {
            "title": "Select States to Compare",
            "orient": "bottom",
            "direction": "horizontal",
            "columns": 3,
            "titleFontSize": 12,
            "labelFontSize": 11
          }
        },
        "opacity": {
          "condition": [
            {"param": "state_select", "empty": false, "value": 1},
            {"test": "datum.category == 'featured'", "value": 1}
          ],
          "value": 0.15
        },
        "strokeWidth": {
          "condition": {
            "test": "datum.state == 'Malaysia (Average)'",
            "value": 4
          },
          "value": 3
        },
        "strokeDash": {
          "condition": {
            "test": "datum.state == 'Malaysia (Average)'",
            "value": [5, 5]
          },
          "value": [0]
        },
        "tooltip": [
          {"field": "state", "type": "nominal", "title": "State"},
          {"field": "year", "type": "quantitative", "title": "Year", "format": "d"},
          {"field": "poverty_rank", "type": "quantitative", "title": "Rank"},
          {"field": "poverty_absolute", "type": "quantitative", "title": "Poverty Rate (%)", "format": ".1f"}
        ]
      }
    },
    {
      "mark": {
        "type": "text",
        "align": "left",
        "dx": 8,
        "fontSize": 11,
        "fontWeight": "bold"
      },
      "transform": [
        {"filter": "datum.year == 2022"}
      ],
      "encoding": {
        "x": {"field": "year", "type": "quantitative"},
        "y": {"field": "poverty_rank", "type": "quantitative"},
        "text": {"field": "state", "type": "nominal"},
        "color": {
          "field": "state",
          "type": "nominal",
          "scale": {
            "domain": ["Selangor", "W.P. Putrajaya", "Malaysia (Average)", "Sabah", "Kelantan"],
            "range": ["#1f77b4", "#ff7f0e", "#2ca02c", "#9467bd", "#8c564b"]
          },
          "legend": null
        },
        "opacity": {
          "condition": [
            {"param": "state_select", "empty": false, "value": 1},
            {"test": "datum.category == 'featured'", "value": 1}
          ],
          "value": 0.15
        }
      }
    },
    {
      "data": {"values": [{"x": 2020}]},
      "mark": {
        "type": "rule",
        "strokeDash": [6, 4],
        "color": "#d32f2f",
        "opacity": 0.6,
        "strokeWidth": 2
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"}
      }
    },
    {
      "data": {"values": [{"x": 2020, "y": 1, "label": "COVID-19"}]},
      "mark": {
        "type": "text",
        "align": "center",
        "baseline": "bottom",
        "dy": -5,
        "fontSize": 10,
        "fontWeight": "bold",
        "color": "#d32f2f"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"field": "label", "type": "nominal"}
      }
    }
  ],
  "config": {
    "view": {"stroke": null}
  }
}
