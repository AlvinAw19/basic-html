{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Teaching Load and Student Success Across States",
    "subtitle": " ",
    "fontSize": 18,
    "anchor": "start",
    "offset": 10
  },
  "width": 460,
  "height": 300,
  "background": null,
  "padding": {"bottom": 5},
  "config": {
    "view": {"stroke": null}
  },
  "data": {"url": "data/teacher_student_ratio.csv"},
  "transform": [
    {"filter": "datum.level != 'Post-Secondary'"},
    {
      "aggregate": [
        {"op": "mean", "field": "ratio", "as": "avg_ratio"},
        {"op": "sum", "field": "students", "as": "total_students"},
        {"op": "sum", "field": "teachers", "as": "total_teachers"}
      ],
      "groupby": ["state"]
    },
    {
      "lookup": "state",
      "from": {
        "data": {"url": "data/completion_school_state.csv"},
        "key": "state",
        "fields": ["completion", "stage"]
      },
      "as": ["completion", "stage"]
    },
    {"filter": "datum.stage != null"},
    {"filter": "year(datum.date) == 2022 || datum.date == null"},
    {
      "aggregate": [
        {"op": "mean", "field": "completion", "as": "avg_completion"},
        {"op": "mean", "field": "avg_ratio", "as": "final_ratio"},
        {"op": "mean", "field": "total_students", "as": "final_students"},
        {"op": "mean", "field": "total_teachers", "as": "final_teachers"}
      ],
      "groupby": ["state"]
    },
    {
      "calculate": "datum.avg_completion >= 98 ? 'High' : 'Moderate'",
      "as": "completion_category"
    }
  ],
  "layer": [
    {
      "mark": {
        "type": "circle",
        "opacity": 0.8,
        "stroke": "#666",
        "strokeWidth": 1
      },
      "encoding": {
        "x": {
          "field": "final_ratio",
          "type": "quantitative",
          "title": "Average Teacherâ€“Student Ratio",
          "scale": {"domain": [10, 14]},
          "axis": {"grid": true, "labelFontSize": 11, "titleFontSize": 12}
        },
        "y": {
          "field": "avg_completion",
          "type": "quantitative",
          "title": "Average Completion Rate (%)",
          "scale": {"domain": [96, 104]},
          "axis": {"grid": true, "labelFontSize": 11, "titleFontSize": 12}
        },
        "size": {
          "field": "final_students",
          "type": "quantitative",
          "title": "Total Students",
          "scale": {"range": [100, 1000]},
          "legend": {
            "orient": "right",
            "values": [200000, 400000, 600000, 800000]
          }
        },
        "color": {
          "condition": {
            "test": "datum.state == 'W.P. Putrajaya'",
            "value": "#6A35B8"
          },
          "value": "#B8A7D9"
        },
        "tooltip": [
          {"field": "state", "type": "nominal", "title": "State"},
          {"field": "final_ratio", "type": "quantitative", "title": "Average Ratio", "format": ".2f"},
          {"field": "avg_completion", "type": "quantitative", "title": "Average Completion Rate", "format": ".1f"},
          {"field": "final_students", "type": "quantitative", "title": "Total Students", "format": ",.0f"},
          {"field": "final_teachers", "type": "quantitative", "title": "Total Teachers", "format": ",.0f"},
          {"field": "completion_category", "type": "nominal", "title": "Category"}
        ]
      }
    },
    {
      "data": {
        "values": [
          {"x": 11.5, "y": 103}
        ]
      },
      "mark": {
        "type": "text",
        "align": "left",
        "dx": -80,
        "dy": -25,
        "fontSize": 11,
        "fontWeight": "bold",
        "color": "#6A35B8"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"value": "W.P. Putrajaya"}
      }
    },
    {
      "data": {
        "values": [
          {"x": 11.5, "y": 102.65}
        ]
      },
      "mark": {
        "type": "text",
        "align": "left",
        "dx": -80,
        "dy": -25,
        "fontSize": 9,
        "color": "#666"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"value": "Lowest teacher-student ratio (10.65:1)"}
      }
    },
    {
      "data": {
        "values": [
          {"x": 11.5, "y": 102.35}
        ]
      },
      "mark": {
        "type": "text",
        "align": "left",
        "dx": -80,
        "dy": -25,
        "fontSize": 9,
        "color": "#666"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"value": "with exceptional completion (104%)"}
      }
    },
    {
      "data": {
        "values": [
          {"x": 12.6, "y": 98}
        ]
      },
      "mark": {
        "type": "text",
        "align": "left",
        "fontSize": 10,
        "color": "#555",
        "fontWeight": "bold"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"value": "Lower teacher-student ratios"}
      }
    },
    {
      "data": {
        "values": [
          {"x": 12.6, "y": 97.7}
        ]
      },
      "mark": {
        "type": "text",
        "align": "left",
        "fontSize": 9,
        "color": "#666"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"value": "tend to correlate with higher"}
      }
    },
    {
      "data": {
        "values": [
          {"x": 12.6, "y": 97.45}
        ]
      },
      "mark": {
        "type": "text",
        "align": "left",
        "fontSize": 9,
        "color": "#666"
      },
      "encoding": {
        "x": {"field": "x", "type": "quantitative"},
        "y": {"field": "y", "type": "quantitative"},
        "text": {"value": "completion rates across states"}
      }
    }
  ]
}
